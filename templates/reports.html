{% extends "base.html" %}

{% block title %}HK_Report_{{ today }}{% endblock %}

{% block content %}
<!-- ... existing content ... -->

<!-- Print Footer -->
<div class="print-only-footer"
  style="display: none; position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 0.8rem; color: #999; border-top: 1px solid #ddd; padding-top: 0.5rem; background: white;">
  Internal Document - Generated by HK Inventory System
</div>

<div class="dashboard-header" style="padding: 1rem 0;">
  <div>
    <h2>Reports & History</h2>
    <p>Detailed transaction log</p>
  </div>
  <div class="no-print" style="display: flex; gap: 1rem; align-items: center;">

    <!-- Column Selector -->
    <div style="position: relative;">
      <button type="button" class="btn btn-secondary" onclick="toggleDropdown()">
        Task Columns ‚ñæ
      </button>
      <div id="colDropdown"
        style="display: none; position: absolute; top: 100%; right: 0; background: var(--bg-card); border: 1px solid var(--border-color); padding: 10px; z-index: 1000; min-width: 180px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border-radius: 8px;">
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(0, 'date')">
            Date</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(1, 'time')">
            Time</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(2, 'type')">
            Type</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(3, 'doc')"> Doc
            #</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(4, 'sku')"> Item
            Code</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(5, 'name')"> Item
            Name</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(6, 'loc')">
            Location</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(7, 'qty')">
            Qty</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(8, 'brand')">
            Brand</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(9, 'plts')">
            Plts</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(10, 'expiry')">
            Expiry</label></div>
        <div style="margin-bottom: 5px;"><label><input type="checkbox" checked onchange="toggleCol(11, 'user')">
            User</label></div>
        <div><label><input type="checkbox" checked onchange="toggleCol(12, 'remarks')"> Remarks</label></div>
      </div>
    </div>

    <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Print / PDF</button>
    <button onclick="exportCSV()" class="btn btn-success"
      style="background: var(--success); color: white; border: none;">üíæ Export CSV</button>
    <a href="{{ url_for('admin_fix_reports') }}" class="btn btn-warning"
      style="background: var(--warning); color: #000;">üîß Repair Data</a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Dashboard</a>
  </div>
</div>

<div class="card" style="padding: 1.5rem;">
  <!-- Filters -->
  <!-- Filters -->
  <form action="{{ url_for('reports') }}" method="GET" class="input-row"
    style="margin-bottom: 2rem; align-items: flex-end; gap: 1rem;">

    <div class="form-group" style="flex: 1; min-width: 200px;">
      <label>Search (Item, Loc, Doc #)</label>
      <input type="text" name="search" value="{{ request.args.get('search', '') }}" placeholder="Keywords...">
    </div>

    <div class="form-group" style="flex: 1; min-width: 150px;">
      <label>Brand</label>
      <input type="text" name="brand" value="{{ request.args.get('brand', '') }}" placeholder="Filter Brand...">
    </div>

    <div class="form-group" style="flex: 0 0 150px;">
      <label>Type</label>
      <select name="type">
        <option value="">All</option>
        <option value="in" {% if request.args.get('type')=='in' %}selected{% endif %}>Inbound (+)</option>
        <option value="out" {% if request.args.get('type')=='out' %}selected{% endif %}>Outbound (-)</option>
      </select>
    </div>

    <div class="form-group" style="flex: 0 0 120px;">
      <label>Min Qty</label>
      <input type="number" name="min_qty" value="{{ request.args.get('min_qty', '') }}" placeholder="0">
    </div>

    <div class="form-group" style="flex: 0 0 120px;">
      <label>Max Qty</label>
      <input type="number" name="max_qty" value="{{ request.args.get('max_qty', '') }}" placeholder="Max">
    </div>

    <div class="form-group" style="flex: 0 0 140px;">
      <label>From Date</label>
      <input type="date" name="start_date" value="{{ request.args.get('start_date', '') }}">
    </div>

    <div class="form-group" style="flex: 0 0 140px;">
      <label>To Date</label>
      <input type="date" name="end_date" value="{{ request.args.get('end_date', '') }}">
    </div>

    <div class="form-group" style="flex: 0 0 auto;">
      <button type="submit" class="btn btn-primary">Filter</button>
      <a href="{{ url_for('reports') }}" class="btn btn-secondary" style="margin-left: 0.5rem;">Reset</a>
    </div>
  </form>

  <!-- Data Table -->
  <!-- Print-only Header -->
  <div class="print-only-header"
    style="display: none; margin-bottom: 2rem; border-bottom: 2px solid #000; padding-bottom: 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <img src="{{ url_for('static', filename='hk_logo.png') }}" alt="HK Logo" style="height: 60px;">
        <div>
          <h1 style="margin: 0; font-size: 1.5rem; color: #000;">HK Inventory System</h1>
          <p style="margin: 0; font-size: 0.9rem; color: #666;">Official Transaction Report</p>
        </div>
      </div>
      <div style="text-align: right;">
        <p style="margin: 0; font-size: 0.9rem;"><strong>Generated:</strong> <span id="printDate"></span></p>
        <p style="margin: 0; font-size: 0.9rem;"><strong>User:</strong> {{ current_user.username }}</p>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="report-table" id="reportsTable" style="font-size: 0.9rem;">

      <tr>
        <th onclick="sortTable(0)" class="sortable">Date ‚Üï</th>
        <th onclick="sortTable(1)" class="sortable">Time ‚Üï</th>
        <th onclick="sortTable(2)" class="sortable">Type ‚Üï</th>
        <th onclick="sortTable(3)" class="sortable">Doc # ‚Üï</th>
        <th onclick="sortTable(4)" class="sortable">Item Code ‚Üï</th>
        <th onclick="sortTable(5)" class="sortable">Item Name ‚Üï</th>
        <th onclick="sortTable(6)" class="sortable">Location ‚Üï</th>
        <th onclick="sortTable(7)" class="sortable">Qty ‚Üï</th>
        <th onclick="sortTable(8)" class="sortable">Brand ‚Üï</th>
        <th onclick="sortTable(9)" class="sortable">Plts ‚Üï</th>
        <th onclick="sortTable(10)" class="sortable">Expiry ‚Üï</th>
        <th onclick="sortTable(11)" class="sortable">User ‚Üï</th>
        <th>Remarks</th>
      </tr>
      </thead>
      <tbody>
        {% for trans in transactions %}
        <tr class="{% if trans.type == 'IN' %}row-in{% else %}row-out{% endif %}">
          <td>{{ trans.timestamp.strftime('%Y-%m-%d') }}</td>
          <td>{{ (trans.timestamp | add_hours(4)).strftime('%H:%M') }}</td>
          <td>
            {% if trans.type == 'IN' %}
            <span class="badge badge-success" data-val="1">IN</span>
            {% else %}
            <span class="badge badge-danger" data-val="0">OUT</span>
            {% endif %}
          </td>
          <td>{{ trans.doc_number or '-' }}</td>
          <td>{{ trans.item.sku if trans.item else '<Deleted>' }}</td>
          <td>{{ trans.item.name if trans.item else '<Deleted>' }}</td>
          <td>{{ trans.location.name if trans.location else '<Deleted>' }}</td>
          <td data-val="{{ trans.quantity }}"
            style="font-weight: bold; {% if trans.type == 'IN' %}color: var(--success);{% else %}color: var(--danger);{% endif %}">
            {{ trans.quantity }}
          </td>
          <td>{{ trans.item.brand if trans.item else '-' }}</td>
          <td>{{ trans.pallets or '-' }}</td>
          <td class="expiry-{{ trans.expiry | check_expiry }}">{{ trans.expiry or '-' }}</td>
          <td>{{ trans.worker_name or (trans.user.username if trans.user else 'System') }}</td>
          <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ trans.remarks
            or '-' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="12" style="text-align: center; padding: 2rem;">No records found matching filters.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="print-only-footer"
    style="display: none; position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 0.8rem; color: #999; border-top: 1px solid #ddd; padding-top: 0.5rem; background: white;">
    Internal Document - Generated by HK Inventory System
  </div>
</div>

<style>
  /* Dense table style for report */
  .report-table th,
  .report-table td {
    padding: 0.75rem 0.5rem;
  }

  .sortable {
    cursor: pointer;
    user-select: none;
  }

  .sortable:hover {
    background-color: var(--bg-input);
    color: var(--primary);
  }

  .row-in:hover {
    background-color: rgba(16, 185, 129, 0.05) !important;
  }

  .row-out:hover {
    background-color: rgba(239, 68, 68, 0.05) !important;
  }

  @media print {

    .no-print,
    .input-row,
    .btn,
    form {
      display: none !important;
    }

    .print-only-header {
      display: block !important;
    }

    .print-only-footer {
      display: block !important;
    }

    .card {
      border: none;
      box-shadow: none;
      padding: 0 !important;
      margin: 0 !important;
    }

    .dashboard-header {
      display: none !important;
    }

    body,
    .card {
      background: white;
      color: black;
      margin: 0;
      padding: 0;
    }

    .container {
      width: 100% !important;
      max-width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    nav {
      display: none !important;
    }

    table {
      font-size: 8pt;
      width: 100%;
      border-collapse: collapse;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2 !important;
      -webkit-print-color-adjust: exact;
    }

    th,
    td {
      border: 1px solid #ccc;
      color: black;
      padding: 2px;
    }

    th {
      background-color: #f0f0f0 !important;
      -webkit-print-color-adjust: exact;
    }

    .badge {
      border: 1px solid #000;
      color: black !important;
      background: none !important;
      padding: 2px 4px;
    }
  }
</style>

<script>
  function sortTable(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("reportsTable");
    switching = true;
    dir = "asc";
    while (switching) {
      switching = false;
      rows = table.rows;
      for (i = 1; i < (rows.length - 1); i++) {
        shouldSwitch = false;
        x = rows[i].getElementsByTagName("TD")[n];
        y = rows[i + 1].getElementsByTagName("TD")[n];

        var xVal = x.querySelector('[data-val]') ? x.querySelector('[data-val]').getAttribute('data-val') : (x.getAttribute('data-val') || x.innerHTML.toLowerCase());
        var yVal = y.querySelector('[data-val]') ? y.querySelector('[data-val]').getAttribute('data-val') : (y.getAttribute('data-val') || y.innerHTML.toLowerCase());

        if (!isNaN(parseFloat(xVal)) && isFinite(xVal) && !isNaN(parseFloat(yVal)) && isFinite(yVal)) {
          xVal = parseFloat(xVal);
          yVal = parseFloat(yVal);
        }

        if (dir == "asc") {
          if (xVal > yVal) {
            shouldSwitch = true;
            break;
          }
        } else if (dir == "desc") {
          if (xVal < yVal) {
            shouldSwitch = true;
            break;
          }
        }
      }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        switchcount++;
      } else {
        if (switchcount == 0 && dir == "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  }

  // --- Column Management ---
  function toggleDropdown() {
    const el = document.getElementById('colDropdown');
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function (event) {
    const dropdown = document.getElementById('colDropdown');
    const btn = event.target.closest('button'); // specific button check?
    // If click is NOT inside dropdown AND NOT on the button that toggles it
    if (dropdown && dropdown.style.display === 'block') {
      if (!event.target.closest('#colDropdown') && (!btn || !btn.textContent.includes('Task Columns'))) {
        dropdown.style.display = 'none';
      }
    }
  });

  function toggleCol(index, key) {
    const table = document.getElementById('reportsTable');
    if (!table) return;

    // Toggle Header
    const th = table.rows[0].cells[index];
    if (th) {
      th.style.display = th.style.display === 'none' ? '' : 'none';
    }

    // Toggle Data Cells
    for (let i = 1; i < table.rows.length; i++) {
      const row = table.rows[i];
      // Skip rows that look like "No records found" (colspan)
      if (row.cells.length === 1 && row.cells[0].getAttribute('colspan')) continue;

      if (row.cells.length > index) {
        const cell = row.cells[index];
        cell.style.display = cell.style.display === 'none' ? '' : 'none';
      }
    }
  }

  function exportCSV() {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('export', 'csv');

    // Gather selected columns
    const keys = ['date', 'time', 'type', 'doc', 'sku', 'name', 'loc', 'qty', 'brand', 'plts', 'expiry', 'user', 'remarks'];
    const checkboxes = document.querySelectorAll('#colDropdown input[type="checkbox"]');
    const selected = [];

    checkboxes.forEach((cb, i) => {
      if (cb.checked && keys[i]) {
        selected.push(keys[i]);
      }
    });

    if (selected.length > 0) {
      currentUrl.searchParams.set('cols', selected.join(','));
    }

    window.location.href = currentUrl.toString();
  }

  // Set print date
  document.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    const el = document.getElementById('printDate');
    if (el) el.textContent = dateStr;
  });
</script>
{% endblock %}