{% extends "base.html" %}

{% block title %}HK_Report_{{ today }}{% endblock %}

{% block content %}
<style>
  /* --- New Clean Design --- */
  .tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid var(--border-color);
  }

  .tab {
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
    font-weight: 600;
    text-decoration: none;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }

  .tab:hover {
    color: var(--text-main);
  }

  .tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }

  .report-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.9rem;
  }

  .report-table th {
    background: var(--bg-dark);
    position: sticky;
    top: 0;
    z-index: 10;
    font-weight: 600;
    color: var(--text-muted);
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }

  .report-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-main);
    vertical-align: middle;
  }

  .report-table tr:last-child td {
    border-bottom: none;
  }

  .report-table tr:hover td {
    background: rgba(255, 255, 255, 0.02);
  }

  /* Tab-specific visibility for Print */
  @media print {

    .no-print,
    .tabs,
    form {
      display: none !important;
    }

    .card {
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
    }

    body {
      background: white;
      color: black;
    }

    table {
      width: 100%;
      font-size: 10pt;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 4px;
      color: black;
    }

    th {
      background: #eee !important;
      -webkit-print-color-adjust: exact;
    }

    .badge {
      border: 1px solid #000;
      color: black !important;
    }

    /* Only show active tab content - handled by server rendering mostly, but good to be safe */
  }
</style>

<div class="dashboard-header"
  style="margin-bottom: 0; padding-bottom: 0; border-bottom: none; border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
  <div style="display: flex; justify-content: space-between; align-items: start;">
    <div>
      <h2>Reports Center</h2>
      <p>View history or print current stock</p>
    </div>
    <div class="no-print" style="display: flex; gap: 1rem;">
      <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Print</button>
      <button onclick="exportCSV()" class="btn btn-success">üíæ Export CSV</button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Dashboard</a>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs no-print" style="margin-top: 1.5rem; margin-bottom: 0;">
    <a href="{{ url_for('reports', report_type='transactions') }}"
      class="tab {% if report_type == 'transactions' %}active{% endif %}">
      üìù Transaction Log
    </a>
    <a href="{{ url_for('reports', report_type='inventory') }}"
      class="tab {% if report_type == 'inventory' %}active{% endif %}">
      üì¶ Current Stock Snapshot
    </a>
  </div>
</div>

<div class="card" style="border-top-left-radius: 0; border-top-right-radius: 0; border-top: none;">

  <!-- FILTERS -->
  <form action="{{ url_for('reports') }}" method="GET" class="input-row no-print"
    style="padding: 1.5rem; padding-bottom: 0; border-bottom: 1px solid var(--border-color); margin-bottom: 0;">
    <input type="hidden" name="report_type" value="{{ report_type }}">

    <div class="form-group" style="flex: 1; min-width: 200px;">
      <label>Search Keywords</label>
      <input type="text" name="search" value="{{ request.args.get('search', '') }}"
        placeholder="Item, SKU, Location, Doc #">
    </div>

    <div class="form-group" style="flex: 0 0 150px;">
      <label>Brand</label>
      <input type="text" name="brand" value="{{ request.args.get('brand', '') }}" placeholder="Filter Brand...">
    </div>

    {% if report_type == 'transactions' %}
    <div class="form-group" style="flex: 0 0 140px;">
      <label>Trans. Type</label>
      <select name="type">
        <option value="">All Types</option>
        <option value="in" {% if request.args.get('type')=='in' %}selected{% endif %}>Inbound (+)</option>
        <option value="out" {% if request.args.get('type')=='out' %}selected{% endif %}>Outbound (-)</option>
      </select>
    </div>
    <!-- Date Range only for History -->
    <div class="form-group" style="flex: 0 0 130px;">
      <label>From Date</label>
      <input type="date" name="start_date" value="{{ request.args.get('start_date', '') }}">
    </div>
    <div class="form-group" style="flex: 0 0 130px;">
      <label>To Date</label>
      <input type="date" name="end_date" value="{{ request.args.get('end_date', '') }}">
    </div>
    {% endif %}

    <div class="form-group" style="flex: 0 0 auto;">
      <label>&nbsp;</label>
      <button type="submit" class="btn btn-primary">Apply Filters</button>
      <a href="{{ url_for('reports', report_type=report_type) }}" class="btn btn-secondary"
        style="margin-left: 0.5rem;">Reset</a>
    </div>
  </form>

  <!-- CONTENT AREA -->
  <!-- Print Header -->
  <div class="print-only-header"
    style="display: none; padding: 2rem; border-bottom: 2px solid #000; margin-bottom: 1rem;">
    <h1 style="margin: 0; font-size: 1.5rem; color: #000;">HK Inventory - {{ 'Current Stock' if report_type ==
      'inventory' else 'Transaction History' }}</h1>
    <p style="margin: 0.5rem 0 0; color: #666;">Generated: {{ today.strftime('%Y-%m-%d') }} | User: {{
      current_user.username }}</p>
  </div>

  <div class="table-responsive" style="padding: 0;">
    {% if report_type == 'transactions' %}
    <!-- TRANSACTION TABLE -->
    <table class="report-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Ref #</th>
          <th>Item</th>
          <th>Location</th>
          <th>Qty</th>
          <th>Plts</th>
          <th>User</th>
          <th>Remarks</th>
        </tr>
      </thead>
      <tbody>
        {% for trans in transactions %}
        <tr
          style="{% if trans.type == 'IN' %}background: rgba(16, 185, 129, 0.02);{% else %}background: rgba(239, 68, 68, 0.02);{% endif %}">
          <td style="white-space: nowrap;">
            <div style="font-weight: 500;">{{ trans.timestamp.strftime('%Y-%m-%d') }}</div>
            <div style="font-size: 0.75rem; color: var(--text-muted);">{{ (trans.timestamp |
              add_hours(4)).strftime('%H:%M') }}</div>
          </td>
          <td>
            {% if trans.type == 'IN' %}
            <span style="color: var(--success); font-weight: 700;">IN (+)</span>
            {% else %}
            <span style="color: var(--danger); font-weight: 700;">OUT (-)</span>
            {% endif %}
          </td>
          <td>{{ trans.doc_number or '-' }}</td>
          <td>
            <div style="font-weight: 600;">{{ trans.item.name }}</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">{{ trans.item.sku }}</div>
          </td>
          <td>{{ trans.location.name }}</td>
          <td
            style="font-weight: 700; {% if trans.type=='IN' %}color: var(--success);{% else %}color: var(--danger);{% endif %}">
            {{ trans.quantity | int }}
          </td>
          <td>{{ trans.pallets or '-' }}</td>
          <td>{{ trans.worker_name or (trans.user.username if trans.user else 'Sys') }}</td>
          <td
            style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-muted);">
            {{ trans.remarks or '-' }}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" style="text-align: center; padding: 3rem; color: var(--text-muted);">No records found matching
            filters.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% else %}
    <!-- STOCK SNAPSHOT TABLE -->
    <table class="report-table">
      <thead>
        <tr>
          <th>Location</th>
          <th>Item Code</th>
          <th>Item Name</th>
          <th>Brand</th>
          <th>Qty</th>
          <th>Plts</th>
          <th>Expiry</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in inventory %}
        <tr>
          <td><span class="badge">{{ inv.location.name }}</span></td>
          <td style="font-family: monospace;">{{ inv.item.sku }}</td>
          <td style="font-weight: 600;">{{ inv.item.name }}</td>
          <td>{{ inv.item.brand or '-' }}</td>
          <td style="color: var(--success); font-weight: 700; font-size: 1.1rem;">{{ inv.quantity | int }}</td>
          <td>{{ inv.pallets or '-' }}</td>
          <td>
            {% if inv.expiry %}
            <span class="expiry-{{ inv.expiry | check_expiry }}">{{ inv.expiry }}</span>
            {% else %}
            -
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">No active inventory
            matches your criteria.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>

</div>

<!-- Internal Footer for Print -->
<div class="print-only-footer"
  style="display: none; position: fixed; bottom: 0; width: 100%; text-align: center; border-top: 1px solid #ddd; padding: 0.5rem; font-size: 0.8rem;">
  HK Inventory System - Internal Use Only
</div>

<script>
  function exportCSV() {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('export', 'csv');
    window.location.href = currentUrl.toString();
  }
</script>
{% endblock %}